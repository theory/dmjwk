name: âœ… Test and Lint
on:
  push:
    branches-ignore: [wip/**]
jobs:
  first-class:
    strategy:
      matrix:
        os:
          - { emoji: ğŸ§, name: linux/amd64, on: ubuntu-latest }
          - { emoji: ğŸ§, name: linux/arm64, on: ubuntu-24.04-arm }
          - { emoji: ğŸ, name: macos/arm64, on: macos-latest }
          - { emoji: ğŸ, name: macos/amd64, on: macos-15-intel }
          - { emoji: ğŸªŸ, name: windows/amd64, on: windows-latest }
    name: ${{ matrix.os.emoji }} ${{ matrix.os.name }}
    runs-on: ${{ matrix.os.on }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with: { submodules: true }
      - name: Setup Go
        uses: actions/setup-go@v5
        with: { go-version-file: go.mod, check-latest: true }
      - name: Run Tests
        run: make test

  bsds:
    name: ${{ matrix.os.emoji }} ${{ matrix.os.name }}/${{ matrix.os.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        os:
          - { name: freebsd, arch: amd64, version: "15.0", emoji: ğŸ˜ˆ }
          - { name: freebsd, arch: arm64, version: "15.0", emoji: ğŸ˜ˆ }
          - { name: openbsd, arch: amd64, version: "7.8", emoji: ğŸ¡ }
          - { name: openbsd, arch: arm64, version: "7.8", emoji: ğŸ¡ }
          - { name: netbsd, arch: amd64, version: "10.1", emoji: â›³ï¸ }
          - { name: netbsd, arch: arm64, version: "10.1", emoji: â›³ï¸ }
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Download Go
        run: |
          curl -Lo go.tgz https://go.dev/dl/go$(grep ^go go.mod | awk '{print $2}').${{ matrix.os.name }}-${{ matrix.os.arch }}.tar.gz
          tar zxf go.tgz
          rm go.tgz
      - name: Run Tests
        uses: cross-platform-actions/action@v0.32.0
        env:
          GOTOOLCHAIN: local
        with:
          operating_system: ${{ matrix.os.name }}
          architecture: ${{ matrix.os.arch == 'amd64' && 'x86-64' || matrix.os.arch }}
          version: ${{ matrix.os.version }}
          run: |
            mv go /tmp
            /tmp/go/bin/go test ./...

  lint:
    name: ğŸ” Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with: { go-version-file: go.mod, check-latest: true }
      - name: Install Dependencies
        run: make debian-lint-depends
      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1
